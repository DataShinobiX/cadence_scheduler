# COMPREHENSIVE GOOGLE OAUTH & TOKEN MANAGEMENT ANALYSIS

## Executive Summary

The application has a **distributed OAuth implementation** with critical authentication issues that explain the 401 errors. The current system stores tokens in the database but has **incomplete token refresh logic** in several critical paths.

---

## 1. GOOGLE OAUTH IMPLEMENTATION OVERVIEW

### 1.1 OAuth Flow Architecture

**Two Separate OAuth Flows:**

1. **Gmail OAuth** - For email tracking (Celery background tasks)
   - Uses: `credentials.json` + `token.json` (file-based)
   - Scopes: `gmail.readonly`, `calendar`
   - Generated by: `generate_gmail_token.py`

2. **Google Calendar OAuth** - For calendar integration
   - Uses: `credentials.json` (file-based) for user setup
   - Tokens stored: In database (`users.google_calendar_token`)
   - Scopes: `calendar`, `calendar.events`
   - Setup by: `setup_google_calendar.py`

### 1.2 Token Storage Locations

| Service | Token Location | Storage Type | Refresh Logic |
|---------|---|---|---|
| **Gmail** | `token.json` file | File system | Manual only in `email_tracking.py` |
| **Calendar API** | `users.google_calendar_token` | PostgreSQL (TEXT) | Auto in `calendar.py` endpoint |
| **Calendar Events Creation** | `token.json` file | File system | Auto in `agent_adapters.py` |

---

## 2. OAUTH IMPLEMENTATION BY COMPONENT

### 2.1 Calendar Page Component (Frontend API)

**File:** `/app/api/calendar.py`

**Token Management Flow:**
```python
# Line 59-71: Retrieve token from database
def _get_user_google_calendar_token(user_id: str) -> Optional[str]:
    """Get user's Google Calendar token from database"""
    SELECT google_calendar_token FROM users WHERE user_id = %s

# Line 74-127: Build service WITH automatic refresh
def _build_google_calendar_service(user_id: str):
    token_json = _get_user_google_calendar_token(user_id)  # From DB
    
    # LINE 95-110: AUTOMATIC TOKEN REFRESH
    if creds.expired and creds.refresh_token:
        print(f"Refreshing expired token for user {user_id}")
        creds.refresh(Request())  # <-- REFRESH HAPPENS HERE
        
        # LINE 103-107: UPDATE DATABASE WITH NEW TOKEN
        UPDATE users SET google_calendar_token = %s WHERE user_id = %s
```

**Key Function:**
- `GET /api/calendar/events` - Fetches events from Google Calendar API
- **Automatic token refresh:** YES (lines 95-110)
- **Database persistence:** YES (lines 103-107)

**Potential 401 Issues in This Component:**
- If token is invalid (not just expired) → raises HTTPException 401 (line 85)
- If token JSON is corrupted → HTTPException 400 (line 117)
- If refresh fails → HTTPException 500 (line 122)

---

### 2.2 Email Tracking Agent (Celery Background Task)

**File:** `/app/agents/email_tracking.py`

**Token Management:**
```python
# Line 51-65: Build Gmail service
def _build_gmail_service(self):
    creds = None
    if os.path.exists(self.token_file):
        creds = Credentials.from_authorized_user_file(self.token_file, SCOPES)
    
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            # LINE 56-57: REFRESH LOGIC
            creds.refresh(Request())  # <-- REFRESH
        else:
            # LINE 58-64: Re-authenticate (requires browser interaction)
            flow = InstalledAppFlow.from_client_secrets_file(...)
            creds = flow.run_local_server(port=0)
        
        # LINE 63-64: SAVE TO FILE
        with open(self.token_file, "w") as token:
            token.write(creds.to_json())
    
    return build('gmail', 'v1', credentials=creds)
```

**Key Points:**
- Token stored in FILE system (`token.json`)
- Automatic refresh: YES (line 56-57)
- Persistence: File system only (line 63-64)
- **No database storage** of Gmail token

**Execution Path:**
1. `email_checker.py` (Celery task) calls this
2. Initializes agent at lines 194-199
3. Calls `_build_gmail_service()` at line 206
4. If token is expired → automatically refreshed (line 56-57)

---

### 2.3 Celery Email Checker Task

**File:** `/app/tasks/email_checker.py`

**OAuth Flow:**
```python
# Line 194-199: Initialize email agent with file-based tokens
email_agent = SimpleEmailSchedulerAdapter(
    credentials_file=credentials_file,  # Located on filesystem
    token_file=token_file,              # Located on filesystem
    api_key="...",
    base_url="..."
)

# Line 206-210: Build service (calls _build_gmail_service internally)
service = email_agent._build_gmail_service()
```

**Issues:**
- Token refresh happens automatically in `_build_gmail_service()`
- But errors are NOT caught → if refresh fails, task fails silently
- No error handling for `401 Unauthorized` responses

---

### 2.4 Scheduler Brain & Calendar Integration

**File:** `/app/orchestration/agent_adapters.py`

**Agent 3 - Calendar Integrator (lines 181-279):**
```python
def execute(self, state: AgentState) -> AgentState:
    # Line 247-250: Initialize integrator
    integrator = SimplifiedCalendarIntegrator(
        credentials_file=self.credentials_file,
        token_file=self.token_file
    )
    
    # Line 253-256: Integrate tasks into calendar
    result = integrator.integrate_tasks(
        user_id=user_id,
        scheduling_plan=scheduling_plan
    )
```

**SimplifiedCalendarIntegrator - Token Management (lines 314-353):**
```python
def _build_calendar_service(self):
    """Build Calendar service using credentials.json and token.json"""
    creds = None
    
    # Load existing token
    if os.path.exists(self.token_file):
        creds = Credentials.from_authorized_user_file(self.token_file, self.scopes)
    
    # LINE 331-333: AUTOMATIC REFRESH
    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            print("Refreshing expired token...")
            creds.refresh(Request())  # <-- REFRESH HAPPENS HERE
        else:
            # Run OAuth flow (requires browser)
            flow = InstalledAppFlow.from_client_secrets_file(...)
            creds = flow.run_local_server(port=0)
        
        # LINE 349-351: SAVE TO FILE
        print("Saving token to...")
        with open(self.token_file, "w") as token:
            token.write(creds.to_json())
    
    return build("calendar", "v3", credentials=creds)
```

**Token Refresh in Event Creation:**
```python
def integrate_tasks(self, user_id: str, scheduling_plan: List[Dict]) -> Dict:
    # Line 386: Insert event with automatic refresh handling
    created_event = self._insert_event_with_retry(event)
    
    # Line 504-511: If 403 (Forbidden) error → retry with exponential backoff
    # But 401 (Unauthorized) errors are NOT handled → will fail
```

---

## 3. TOKEN STORAGE & DATABASE SCHEMA

### 3.1 Database Schema for Google Tokens

**File:** `/scripts/init_db.sql`

**Users Table (lines 13-32):**
```sql
CREATE TABLE IF NOT EXISTS users (
    user_id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255),
    timezone VARCHAR(50) DEFAULT 'UTC',
    google_calendar_token TEXT,        -- <-- CALENDAR TOKEN (JSON string)
    gmail_token TEXT,                  -- <-- GMAIL TOKEN (JSON string) - UNUSED!
    preferences JSONB DEFAULT '{...}'::jsonb,
    onboarding_completed BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Auth Sessions Table - MISSING!**
```
The code references auth_sessions table BUT it's not defined in init_db.sql!
Used in: app/api/auth.py (lines 114-120, 186-195, 254-276)
```

### 3.2 Token Data Format

Tokens are stored as **JSON strings** in database:

```json
{
  "type": "authorized_user",
  "client_id": "...",
  "client_secret": "...",
  "refresh_token": "...",
  "access_token": "...",
  "token_expiry": "2025-01-15T12:34:56Z",
  "scopes": ["https://www.googleapis.com/auth/calendar"],
  "universe_domain": "googleapis.com"
}
```

---

## 4. CRITICAL TOKEN REFRESH LOGIC ISSUES

### 4.1 Missing Automatic Refresh in 4 Places

**ISSUE 1: Email Checker Task (email_checker.py)**

```python
# Line 206: Calls _build_gmail_service() which refreshes token
service = email_agent._build_gmail_service()

# BUT: No try-catch for 401 errors when calling Gmail API
# If refresh fails SILENTLY, subsequent API calls will get 401
```

**Issue:** Refresh errors are NOT caught, causing silent failures.

---

**ISSUE 2: Scheduler Brain using File-based Token**

```python
# app/orchestration/agent_adapters.py line 247-250
integrator = SimplifiedCalendarIntegrator(
    credentials_file=self.credentials_file,  # App defaults to app/models/
    token_file=self.token_file               # app/models/token.json
)
```

**Problem:**
- Uses file-based token, not database token
- If file doesn't exist → runs OAuth flow (requires browser!)
- Happens during task scheduling (no user interaction available)
- User gets 401 error when creating calendar events

---

**ISSUE 3: Missing Token Update in Email Agent**

```python
# app/agents/email_tracking.py lines 63-64
with open(self.token_file, "w") as token:
    token.write(creds.to_json())

# Token is ONLY saved to file, NOT to database!
# Gmail token stored in database is NEVER updated
```

---

**ISSUE 4: Calendar API Token Expires Without Refresh in Scheduler**

The scheduler doesn't use the calendar API endpoint that has automatic refresh:

```
❌ Scheduler uses: app/orchestration/agent_adapters.py (file-based, older refresh)
✅ Frontend uses: app/api/calendar.py (DB-based, newer refresh)
```

---

## 5. WHERE 401 ERRORS OCCUR

### Root Cause Analysis

| Location | Cause | When Happens |
|----------|-------|---|
| **Calendar API Endpoint** | Token expired, no refresh_token in DB | User's token invalid from start |
| **Email Checker Task** | Refresh fails silently, then Gmail API returns 401 | Token file corrupted or missing |
| **Scheduler Brain** | Token file missing, tries OAuth flow, fails | Running in background with no browser |
| **Calendar Integration** | Using old file-based tokens with no fallback | Creating calendar events fails 401 |

### 5.1 Specific 401 Error Scenarios

**Scenario 1: User Connects Google Calendar**
```
1. User runs: python setup_google_calendar.py user@example.com
2. OAuth flow opens browser → user authorizes
3. Token saved to: users.google_calendar_token (JSON string)
4. Frontend calls: GET /api/calendar/events
   ✅ Works: Endpoint has automatic refresh (line 95-110)
```

**Scenario 2: User Manually Refreshes Tokens**
```
1. User is in Calendar view
2. Refresh token expires (normally 7 days)
3. Calendar API endpoint attempts refresh (line 95-110)
   ✅ Works: Uses Google's Credentials.refresh(Request())
4. Updates DB with new token (line 104-107)
```

**Scenario 3: Email Checker Task Runs**
```
1. Celery scheduler runs check_emails_and_schedule() every 5 min
2. Initializes SimpleEmailSchedulerAdapter (line 194-199)
3. Calls _build_gmail_service() (line 206)
   - Checks token.json exists ✓
   - Token is expired ✓
   - Refreshes automatically (line 56-57) ✓
   - Saves to file (line 63-64) ✓
4. Gets Gmail messages (line 213-216)
   ❌ If step 3 refresh failed → 401 error
```

**Scenario 4: Scheduler Brain Creates Calendar Event**
```
1. Email task completes → calls run_orchestration() (line 285)
2. Agent 3 (Calendar Integrator) starts (line 221)
3. Initializes SimplifiedCalendarIntegrator (line 247-250)
4. Calls _build_calendar_service() (line 308)
   - Checks app/models/token.json exists ❌ (might not exist)
   - If not: runs InstalledAppFlow.run_local_server() (line 346)
   - Fails because: NO BROWSER available (background task!)
5. ❌ 401 Error creating calendar event
```

---

## 6. TOKEN FLOW DIAGRAM

```
┌─────────────────────────────────────────────────────────────────┐
│                    USER AUTHENTICATION                          │
├─────────────────────────────────────────────────────────────────┤
│
├─→ setup_google_calendar.py (MANUAL SETUP)
│   ├─ User runs: python setup_google_calendar.py email@test.com
│   ├─ OAuth Flow: Browser opens
│   ├─ Scopes: calendar, calendar.events
│   └─ Stores in: users.google_calendar_token (DB)
│
├─→ generate_gmail_token.py (MANUAL SETUP)
│   ├─ User runs: python generate_gmail_token.py
│   ├─ OAuth Flow: Browser opens
│   ├─ Scopes: gmail.readonly, calendar
│   └─ Stores in: token.json (FILE SYSTEM)
│
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│              CALENDAR API FLOW (Frontend)                       │
├─────────────────────────────────────────────────────────────────┤
│
GET /api/calendar/events (with Bearer token)
  ↓
require_auth(request) → validates session token → gets user_id
  ↓
_get_user_google_calendar_token(user_id) → reads from DB
  ↓
_build_google_calendar_service(user_id)
  ├─ Parse JSON token from DB
  ├─ Create Credentials object
  ├─ IF expired AND has refresh_token:
  │   ├─ creds.refresh(Request())  ← AUTO REFRESH
  │   └─ UPDATE DB with new token  ← PERSISTENCE
  └─ Return calendar service
  ↓
service.events().list(...).execute()
  ↓
Return events to frontend ✓ (or 401 if all refresh attempts fail)

```

---

## 7. MISSING AUTOMATIC REFRESH LOGIC

### Components WITH Proper Refresh:

✅ **app/api/calendar.py**
- Location: `_build_google_calendar_service()` lines 95-110
- Refreshes: Yes, automatic
- Persists: Yes, updates database
- Used by: Frontend calendar endpoint

✅ **app/agents/email_tracking.py**
- Location: `_build_gmail_service()` lines 56-57
- Refreshes: Yes, automatic
- Persists: Yes, to file
- Used by: Email checker task

✅ **app/orchestration/agent_adapters.py (SimplifiedCalendarIntegrator)**
- Location: `_build_calendar_service()` lines 331-333
- Refreshes: Yes, automatic
- Persists: Yes, to file
- Used by: Scheduler brain

### Components WITHOUT Proper Refresh:

❌ **app/models/calendar_event.py (CalendarIntegratorAgent)**
- Has refresh logic but is UNUSED by current code
- Location: lines 87-117
- Note: Old code that's not integrated

---

## 8. HOW TOKENS ARE PASSED BETWEEN SERVICES

### Service-to-Service Communication

**Path 1: Frontend → Calendar API**
```
Browser
  ↓ (sends Bearer token in Authorization header)
Frontend JS
  ↓ GET /api/calendar/events?start_date=...&end_date=...
FastAPI
  ↓ require_auth() → validates session token → gets user_id
  ↓ _get_user_google_calendar_token(user_id)
  ↓ Reads google_calendar_token from DB
  ↓ creds.refresh(Request()) if expired
  ↓ build("calendar", "v3", credentials=creds)
Google Calendar API
  ↓
Response with events
```

**Path 2: Email Task → Google Gmail API**
```
Celery Beat Scheduler (every 5 min)
  ↓ check_emails_and_schedule() Celery task
  ↓ SimpleEmailSchedulerAdapter(credentials_file, token_file)
  ↓ _build_gmail_service()
  ↓ Reads token.json from file system
  ↓ creds.refresh(Request()) if expired
  ↓ build('gmail', 'v1', credentials=creds)
Google Gmail API
  ↓
Gmail messages
  ↓
Extract tasks → save to tasks table
  ↓ run_orchestration() to schedule
```

**Path 3: Scheduler → Google Calendar API**
```
Orchestration Pipeline (triggered by email task)
  ↓ Agent 3 (Calendar Integrator)
  ↓ SimplifiedCalendarIntegrator(credentials_file, token_file)
  ↓ _build_calendar_service()
  ↓ Reads token.json from file system (⚠️ might not exist!)
  ↓ If missing: tries InstalledAppFlow.run_local_server() (fails!)
  ↓ If exists + expired: creds.refresh(Request())
  ↓ build("calendar", "v3", credentials=creds)
Google Calendar API
  ↓
Creates event
  ↓
Returns event ID
```

---

## 9. MISSING AUTOMATIC REFRESH IMPLEMENTATION

### Required Fix #1: Add Auth Sessions Table

```sql
CREATE TABLE IF NOT EXISTS auth_sessions (
    session_token UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP + INTERVAL '7 days',
    last_used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ended_at TIMESTAMP,
    CONSTRAINT valid_expiry CHECK (expires_at > created_at)
);
```

### Required Fix #2: Use Database Token in Scheduler

**Current (Broken):**
```python
# app/orchestration/agent_adapters.py line 247-250
integrator = SimplifiedCalendarIntegrator(
    credentials_file=self.credentials_file,
    token_file=self.token_file  # Uses file system
)
```

**Should Use Database:**
```python
# Proposed fix:
def _build_calendar_service_from_db(self, user_id: str):
    token_json = self._get_user_google_calendar_token(user_id)
    if not token_json:
        raise HTTPException(401, "Google Calendar not connected")
    
    creds = Credentials.from_authorized_user_info(json.loads(token_json))
    if creds.expired and creds.refresh_token:
        creds.refresh(Request())
        self._update_token_in_db(user_id, creds.to_json())
    
    return build("calendar", "v3", credentials=creds)
```

### Required Fix #3: Error Handling in Email Task

```python
# app/tasks/email_checker.py around line 206
try:
    service = email_agent._build_gmail_service()
except Exception as e:
    print(f"[EMAIL TASK] ❌ Failed to build Gmail service: {e}")
    print(f"[EMAIL TASK] Token may be invalid or refresh failed")
    # Notify user to reconnect Gmail
    return {
        'status': 'error',
        'message': 'Failed to authenticate with Gmail',
        'error': str(e)
    }
```

---

## 10. SUMMARY TABLE: OAUTH IMPLEMENTATION STATUS

| Feature | Status | Location | Notes |
|---------|--------|----------|-------|
| **Gmail OAuth Setup** | ✅ Complete | `generate_gmail_token.py` | Manual browser-based setup |
| **Calendar OAuth Setup** | ✅ Complete | `setup_google_calendar.py` | Manual browser-based setup |
| **Token Storage** | ⚠️ Partial | DB + File | Gmail in file, Calendar in DB |
| **Automatic Refresh** | ⚠️ Inconsistent | Multiple places | 3 implementations, 1 missing |
| **Token Persistence** | ❌ Issue | `email_tracking.py` | Gmail token not persisted to DB |
| **Error Handling** | ❌ Incomplete | Email task | No 401 handling in background tasks |
| **Auth Sessions Table** | ❌ Missing | DB schema | Referenced but not created |
| **Calendar in Scheduler** | ❌ Broken | `agent_adapters.py` | Uses file token, fails when missing |

---

## 11. ACTIONABLE RECOMMENDATIONS

### IMMEDIATE (Critical):

1. **Create auth_sessions table** - Currently missing from schema
   
2. **Fix Scheduler Brain Calendar Integration**
   - Use database token instead of file-based
   - Add proper error handling for missing/invalid tokens
   
3. **Add Error Handling to Email Task**
   - Catch 401 errors from Gmail API
   - Notify user if authentication fails
   - Don't silently fail

### SHORT TERM:

4. **Consolidate Token Storage**
   - Store both Gmail and Calendar tokens in database
   - Remove file-based tokens for production
   - Keep file tokens only for backward compatibility

5. **Implement Token Refresh Queue**
   - Proactively refresh tokens before expiry
   - Don't wait for API error to refresh

### LONG TERM:

6. **Add Token Status Monitoring**
   - Track token validity in database
   - Alert users when reconnection needed
   - Automatic retry with exponential backoff

7. **Multi-account Support**
   - Support multiple Google accounts per user
   - Switch between accounts without re-auth

---

## File Paths Summary

```
Core OAuth Files:
├── /app/api/auth.py                          (Session-based auth - missing table!)
├── /app/api/calendar.py                      (Calendar API - good refresh logic)
├── /app/middleware/auth.py                   (Auth middleware)
├── /app/agents/email_tracking.py            (Gmail OAuth - file-based token)
├── /app/tasks/email_checker.py              (Email background task)
├── /app/orchestration/agent_adapters.py     (Scheduler integration - broken)
├── /app/models/calendar_event.py            (Unused calendar integration)
├── /scripts/init_db.sql                      (Database schema - auth_sessions missing)
├── generate_gmail_token.py                   (Gmail setup script)
└── setup_google_calendar.py                  (Calendar setup script)

Configuration & Credentials:
├── credentials.json                          (OAuth app credentials)
├── token.json                                (Gmail/Calendar token file)
└── .env                                      (Database credentials)
```

